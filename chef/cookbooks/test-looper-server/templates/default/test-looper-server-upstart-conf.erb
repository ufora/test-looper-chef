description "test-looper-server"
author      "ufora"

setuid <%= @service_account %>
setgid <%= @service_account %>

start on filesystem and started networking and started redis-server
respawn
respawn limit 20 40
kill signal SIGKILL

env HOME=/home/<%= @service_account %>
env PYTHONPATH=<%= @service_dir %>
env GIT_SSH=<%= @git_ssh_wrapper %>
env LOG_FILE=<%= @log_file %>
env STACK_FILE=<%= @stack_file %>
env TEST_LOOPER_TASKS_ROOT=<%= @tasks_root %>


# used by TestLooperAutomatedDeploy subsystem
env TEST_LOOPER_SERVER_BUILD_DIR=/mnt/deploy-src
env INSTALL_DEPENDENCIES_EXPECTED_VERSION=7c69b38771e10af88e992cb2313becfc44e74dab


# belong to ufora organization
env TEST_LOOPER_APP_CLIENT_ID=<%= @test_looper_github_oauth_app_id %>
env TEST_LOOPER_APP_CLIENT_SECRET=<%= @test_looper_github_app_client_secret %>

env TZ=US/Eastern

pre-start script
    cd $PYTHONPATH
    git remote update
    git checkout -f origin/<%= @git_branch %>
end script

script
    cd $PYTHONPATH
    python ufora/scripts/test-looper-server.py --httpPort=<%= @http_port %> --stackdump $STACK_FILE >> $LOG_FILE 2>&1
end script
